<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>회원 수정</title>
    <style layout:fragment="style">
        .hide {display: none;}
        .fail {color: #ff0000;}
    </style>
</head>
<body>

<div layout:fragment="content">
    <div class="menu">
        <a th:href="@{/member/memberInfo}">회원정보확인</a>
        <a th:href="@{/member/modifyMember}">회원정보수정</a>
        <a th:href="@{/member/modifyPasswd}">비밀번호 변경</a>
        <a th:href="@{/member/modifyMyCat}">고양이 정보 수정</a>
    </div>

    <h1> 회원 정보 수정 </h1>

    <div class="row">
        <div class="col-lg-8" data-aos="fade-up" data-aos-delay="200">
            <form id="frmMod" th:action="@{/member/modifyMember}" method="post">
                <input type="hidden" name="mno" th:value="${#authentication.principal.mno}">
                <div class="row">
                    <div class="col-12 mb-3">
                        <label class="form-label">아이디</label>
                        <input id="memberId" type="text" class="form-control" name="memberId" th:value="${#authentication.principal.memberId}" readonly>
                    </div>

                    <!-- 전화번호 -->
                    <div class="row">
                        <label class="form-label">전화번호</label>
                        <div class="col-4 mb-3">
                            <select id="phoneSelect" class="form-select input-phone" style="height: 54px;">
                                <option th:selected="${phones[0] == '010'}">010</option>
                                <option th:selected="${phones[0] == '011'}">011</option>
                                <option th:selected="${phones[0] == '016'}">016</option>
                                <option th:selected="${phones[0] == '017'}">017</option>
                                <option th:selected="${phones[0] == '019'}">019</option>
                            </select>
                        </div>
                        <div class="col-4 mb-3">
                            <input type="text" class="form-control input-phone" th:value="${phones[1]}" required>
                        </div>
                        <div class="col-4 mb-3">
                            <input type="text" class="form-control input-phone" th:value="${phones[2]}" required>
                            <input id="phone" type="hidden" name="phone" th:value="${#authentication.principal.phone}">
                        </div>
                    </div>

                    <div class="row">
                        <label class="form-label">이메일</label>
                        <div class="col-4 mb-3">
                            <input id="emailId" type="text" class="form-control" th:value="${emails[0]}" required>
                        </div>

                        <div class="col-4 mb-3">
                            <input id="domain" type="text" class="form-control" th:value="${emails[1]}" required>
                            <input type="hidden" name="email" th:value="${#authentication.principal.email}">
                        </div>

                        <div class="col-2 mb-3">
                            <select id="domainSelect" class="form-select" style="height: 54px;">
                                <option value="-1" selected>직접입력</option>
                                <option value="@naver.com">naver.com</option>
                                <option value="@daum.net">daum.net</option>
                                <option value="@gmail.com">gmail.com</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-2 mb-3">
                        <button id="emailBtn" type="button" class="btn btn-primary" style="height: 54px;">인증하기</button>
                    </div>

                    <div class="col-6 mb-3">
                        <input type="text" name="confirmKey" class="form-control" placeholder="인증번호">
                    </div>
                    <div class="col-6 mb-3">
                        <button id="confirmKeyBtn" type="button" class="btn btn-primary">확인</button>
                    </div>

                    <div class="col-6 mb-3">
                        <input id="memberName" type="text" name="memberName" class="form-control" th:value="${#authentication.principal.memberName}"/>
                    </div>
                    <div class="col-6 mb-3">
                        <input id="nickName" type="text" name="nickName" class="form-control" th:value="${#authentication.principal.nickName}"/>
                        <span class="nickNameCheck-message hide">2 ~ 10글자, 숫자, 영어, 한글을 사용하세요.</span>
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">정보저장</button>
                        <button id="infoBtn" type="button" class="btn btn-secondary">뒤로가기</button>
                        <button id="removeBtn" type="button" class="btn btn-danger">회원탈퇴</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/signup/validation.js"></script>
</div>

<script layout:fragment="script" th:inline="javascript">

    // 도메인 셀렉트박스
    const domainSelect = document.getElementById('domainSelect');
    const domainInput = document.getElementById('domain');
    domainSelect.addEventListener('change', function (e) {
        console.log(e.target.value);
        // 기타입력 아닐때
        if (e.target.value !== "-1") {
            console.log("비활성");
            domainInput.disabled = true;
            domainInput.value = e.target.value;
        }
        else {
            domainInput.disabled = false;
            domainInput.value = "";
            domainInput.focus();
        }
    });

    // 이메일 인증번호 전송
    let currentTime = 0;
    const email = document.querySelector('input[name=email]'); // 이메일을 담을 input
    document.getElementById('emailBtn').addEventListener('click', async function (e) {
        const emailId = document.getElementById('emailId').value;
        const domain = domainInput.value;
        const mailTo = emailId + domain;

        let timerInterval; // setInterval id 값
        currentTime = 1000 * 60 * 3; // 타이머 시간

        if (!isEmailValid(mailTo)) {
            alert("올바른 이메일 주소를 작성해주세요.");
        }
        else {
            const result = await sendConfirmMail(mailTo);
            if (result.toString() === "true") {
                alert('인증번호가 전송되었습니다.');
                // 이메일 저장
                email.value = mailTo;
                // 인증하기 버튼 비활성화
                e.target.disabled = true;

                // 이메일 인증 타이머
                timerInterval = setInterval(function () {

                    if (currentTime <= 0) { // 남은 시간이 0초 일때
                        clearInterval(timerInterval);
                        removeConfirmKey(); // 세션에 저장된 인증코드 삭제
                        e.target.disabled = false; // 인증하기 버튼 활성화
                        e.target.textContent = '인증하기';

                        return;
                    }

                    const sec = (currentTime / 1000) % 60;
                    const min = Math.floor(currentTime / (60 * 1000));
                    e.target.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
                    currentTime = currentTime - 1000;
                }, 1000);
            }
            else {
                alert('인증번호 전송 실패');
            }
        }
    });

    // 이메일 인증번호 확인
    document.getElementById('confirmKeyBtn').addEventListener('click', async function () {
        const confirmKeyInput = document.querySelector('input[name=confirmKey]');
        const result = await matchConfirmKey(confirmKeyInput.value);

        if (result === "true") {
            alert('인증이 완료되었습니다.');
            currentTime = 0; // 타이머 초기화
        }
        else {
            alert('인증 실패');
            // 이메일 인증 실패시 초기화
            email.value = "";
        }
    });

    const phoneInputs = document.querySelectorAll('input.input-phone');
    const phoneHiddenInput = document.querySelector('input[name=phone]');
    let phoneOptValue = document.getElementById('phoneSelect').value;
    // 전화번호 앞자리 셀렉트 박스
    document.getElementById('phoneSelect').addEventListener('change', function (e) {
        phoneOptValue = e.target.value;
        phoneHiddenInput.value = `${phoneOptValue}-${phoneInputs[0].value}-${phoneInputs[1].value}`;
    });
    // 전화번호 중간 뒷자리
    phoneInputs.forEach(input => {
        input.addEventListener('change', function () {
            phoneHiddenInput.value = `${phoneOptValue}-${phoneInputs[0].value}-${phoneInputs[1].value}`;
        });
    });

    // 닉네임 확인
    document.querySelector('input[name=nickName]').addEventListener('keyup', function (e) {
        const nickName = e.target.value;
        const checkMsg = document.querySelector('.nickNameCheck-message');
        console.log(nickName);

        if (!onlyNumbersAndEnglishAndKorean(nickName)) {
            checkMsg.classList.add('fail');
        }
        else {
            checkMsg.classList.remove('fail');
        }
    });

    const frmMod = document.getElementById('frmMod');

    // 뒤로가기 버튼
    document.getElementById('infoBtn').addEventListener('click', function () {
        self.location = '/member/memberInfo';
    });

    // 회원탈퇴 버튼
    document.getElementById('removeBtn').addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        frmMod.action = '/member/exit';
        frmMod.submit();
    });

</script>
</body>
</html>