<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>메인 페이지</title>
    <link rel="stylesheet" th:href="@{/css/mainBoard.css}">
</head>
<style layout:fragment="style">
    .searchBtn:hover {
        background-color: #f48fb1;
    }
  #mainViewModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
  }
    /* 닫기 버튼 스타일 */
    .close {
        position: absolute;
        top: 10px;
        right: 10px;
        cursor: pointer;
    }
</style>
<body>
    <div layout:fragment="content">
<!--        검색 창-->
        <form action="/main" method="get" name="frmSearch">
            <div class="col">
                <input type="hidden" name="size" th:value="${pageRequestDTO.size}">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <select class="form-select" id="type" th:name="type">
                            <option value="">---</option>
                            <option value="title" >제목</option>
                            <option value="content">내용</option>
                            <option value="nickName" >닉네임</option>
                            <option value="memberId">아이디</option>
                        </select>
                    </div>
                    <input type="text" class="form-control" id="keyword" name="keyword">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary searchBtn" type="submit">Search</button>
                    </div>
                </div>
            </div>
        </form>

        <div class="row mb-4">
            <div class="col-sm-6">
                <h2 class="posts-entry-title">Pink Jelly</h2>
            </div>
            <div class="col-sm-6 text-sm-end"><a href="category.html" class="read-more">View All</a></div>
            <a th:href="|@{/main/write}|" class="btn btn-primary">글쓰기</a>
        </div>

        <!-- 게시글 목록 -->
        <div class="row" id="wrap">

        </div>

<!--        &lt;!&ndash; 게시글 상세 모달 &ndash;&gt;-->
<!--        <div id="mainViewModal" class="modal" tabindex="-1">-->
<!--            <div class="modal-dialog modal-lg">-->
<!--                <div class="modal-content">-->
<!--                    <div class="modal-header">-->
<!--                        <h5 class="modal-title">소개글을 입력하세요</h5>-->
<!--                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--                    </div>-->
<!--                    <div class="modal-body">-->
<!--                        <div></div>-->
<!--                    </div>-->
<!--                    <div class="modal-footer">-->
<!--                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>-->
<!--                        <button type="button" class="btn btn-primary registerBtn">저장</button>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
        <script src="/js/mainBoard/list.js"></script>
        <script src="/js/signup/upload.js"></script>
    </div>

<script layout:fragment="script" th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // 탈퇴한 회원일경우
        let isDel;
        isDel = [[${isDel}]];
        console.log(isDel);

        if(isDel === true){
            alert('탈퇴한 계정입니다');
        }

        // 페이징 재료
        let pageResponse = [[${mainBoardList}]];
        let page = 1; // 페이지
        let size = 21; // 한번에 출력할 게시물 수
        let total = pageResponse.total; // 총 게시물 수
        let end = Math.ceil(total / size); // 마지막 페이지

        // 첫 화면 로드시 리스트 추가
        getList();

        // 스크롤이벤트 적용
        window.addEventListener('scroll', function () {
            console.log('bodyHeight', document.body.offsetHeight);
            console.log('(window.innerHeight + window.scrollY)', window.innerHeight + window.scrollY);
            if ((document.body.offsetHeight * 0.9) <= (window.innerHeight + window.scrollY)) {
                 // 페이지 증가
                console.log("page++: ", page)
                console.log("end: ", end);
                if (page <= end) {
                    getList();
                }
            }
        });

        // 게시글 목록 가져오기
        async function getList() {
            const url = `/main/getList?page=${page}&size=${size}`;
            try {
                const response = await axios.get(url);
                const mainBoardList = response.data.dtoList;
                pageResponse = response.data;
                console.log("mainBoardList : ", mainBoardList);
                console.log("pageResponse : ", pageResponse);
                console.log("page : " + pageResponse.page);

                // 게시물 목록
                const plusList = mainBoardList.map(mainBoard => `
                            <div class="col-lg-4 mb-4">
                                <div class="post-entry-alt">
                                    <a href="/main/view?mbNo=${mainBoard.mbNo}" class="img-link">
                                        <img src="/upload/mainBoardView/${mainBoard.boardDateString[0]}/${mainBoard.mainImg[0]}" alt="Image" class="img-fluid">
                                    </a>
                                    <div class="excerpt">
                                        <h2><a href="/main/view?mbNo=${mainBoard.mbNo}">${mainBoard.title}</a></h2>
                                        <p>${mainBoard.content}</p>
                                        <div class="post-meta align-items-center text-left clearfix">
                                            <figure class="author-figure mb-0 me-3 float-start"><img src="/upload/profileView/${mainBoard.dateString}/${mainBoard.profileImg}" alt="Image placeholder" class="img-fluid"></figure>
                                            <a href="/profile/friendProfile?memberId=${mainBoard.memberId}">
                                                <span class="d-inline-block mt-1 boardNickName">${mainBoard.nickName}</span>
                                                <span class="boardMemberId">${mainBoard.memberId}</span>
                                            </a>
                                            <span>${mainBoard.addDate[0]+"-"+mainBoard.addDate[1]+"-"+mainBoard.addDate[2]+""+mainBoard.addDate[3]+":"+mainBoard.addDate[4]+":"+mainBoard.addDate[5]}</span><br>
                                            <p class="likeHitCnt">
                                                <span><i class="fa-solid fa-heart"></i>${mainBoard.like}</span>
                                                <span><i class="fa-solid fa-comment"></i>${mainBoard.commentCnt}</span>
                                                <span><i class="fa-solid fa-eye"></i>${mainBoard.hit}</span>
                                            </p>
                                        </div>
                                        <p><a href="#" class="read-more">Continue Reading</a></p>
                                    </div>
                                </div>
                            </div>
                        `).join('');


                document.getElementById('wrap').innerHTML += plusList;
                page++; // 페이지 증가
            } catch(error) {
                console.error('에러발생 ' , error);
            }
        }
    });

const modal =new bootstrap.Modal(document.getElementById('mainViewModal'));
    const modalMemberId = document.querySelector('.modalMemberId');
    const modalNickName = document.querySelector('.modalNickName');
    const modalProfile = document.querySelector('.modalProfile');
    const modalTitle = document.querySelector('.modalTitle');
    const modalContent = document.querySelector('.modalContent');

    modal.show();

    function modalBtn(mbNo){
        console.log(mbNo);
        getBoard(mbNo).then(data =>{
            console.log(data);
            modalMemberId.textContent=data.memberId;
            modalNickName.textContent=data.nickName;
            modalProfile.textContent=data.profileImg;
            modalTitle.textContent=data.title;
            modalContent.textContent=data.content;

         })
        modal.show();
    }
    function closeModal() {
        modal.hide();
    }
</script>
</body>
</html>